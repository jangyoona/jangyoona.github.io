<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>마이페이지</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- jQuery -->
  <script src="/plugins/jquery/jquery.min.js"></script>
  <!-- jQuery UI -->
  <script src="/plugins/jquery-ui/jquery-ui.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- fullCalendar -->
  <link rel="stylesheet" href="/plugins/fullcalendar/main.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="/dist/css/adminlte.min.css">
<!--  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">-->

  <!-- summernote -->
  <link rel="stylesheet" href="/plugins/summernote/summernote-bs4.css">
  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Bootstrap Icon -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
  <!-- Date picker -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
  <Style>
    .datepicker {
        text-align: center,
    }

    .att-container {
      display: grid;
      grid-template-rows: 50px 1fr;
    }

    .search-container {
<!--      display: grid;-->
<!--      grid-template-columns: 1fr 1fr 1fr;-->
      display: flex;
      flex-direction: row;
      column-gap: 2rem;
    }

    .calendar-container {
      display: flex;
      column-gap: 1rem;
    }

    .calendar-container > .date-input {
      display: flex;
      column-gap: 0.3rem;
    }

    .calendar-container > .date-input > i {
      font-size: 1.3rem;
      align-content: center;
    }

    .month-container {
      display: flex;
      flex-direction: row;
      column-gap: 0.5rem;
      align-items: end;
    }

    .search-tool {
      display: flex;
      align-items: end;
    }

  </Style>
</head>
<body class="hold-transition sidebar-mini">
  <div class="wrapper">

  <div th:replace="~{/modules/main-header-navbar}"></div>
  <div th:replace="~{/modules/main-sidebar}"></div>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->



    <div class="card card-primary card-outline">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-edit"></i>
          마이페이지
        </h3>
      </div>
      <div class="card-body">
        <h4>Menu</h4>
        <div class="row">
          <div class="col-5 col-sm-3">
            <div class="nav flex-column nav-tabs h-100" id="vert-tabs-tab" role="tablist" aria-orientation="vertical">
              <a class="nav-link active my-info-btn" id="vert-tabs-home-tab" data-toggle="pill" href="#tab1" role="tab" aria-controls="tab1" aria-selected="true">내정보</a>
              <a class="nav-link my-memo-btn" id="vert-tabs-profile-tab" data-toggle="pill" href="#tab2" role="tab" aria-controls="tab2" aria-selected="false">일정관리</a>
              <a class="nav-link my-fileBox-btn" id="my-fileBox-tab" data-toggle="pill" href="#tab3" role="tab" aria-controls="tab3" aria-selected="false">개인파일함</a>
              <a class="nav-link my-attendance-btn" id="vert-tabs-messages-tab" data-toggle="pill" href="#tab4" role="tab" aria-controls="tab4" aria-selected="false">근태현황</a>
              <a class="nav-link my-loginAttempt-btn" id="vert-tabs-settings-tab" data-toggle="pill" href="#tab5" role="tab" aria-controls="tab5" aria-selected="false">로그인 조회</a>
              <a class="nav-link my-bookmark-btn" id="my-bookmark-tab" data-toggle="pill" href="#tab6" role="tab" aria-controls="tab6" aria-selected="false">즐겨찾기</a>
            </div>
          </div>
          <div class="col-7 col-sm-9">
            <div class="tab-content " id="vert-tabs-tabContent">
              <div class="tab-pane text-left fade show active my-info-div" id="tab1" role="tabpanel" aria-labelledby="vert-tabs-home-tab">
                <div class="my-info-container" id="my-info-container">
                내정보 영역
                  <!-- Project list AND Pagination Btn -->
                </div>
              </div>

              <div class="tab-pane fade my-memo-container" id="tab2" role="tabpanel" aria-labelledby="vert-tabs-profile-tab">
                <!-- 메모장 영역 -->
                <div class="todo-container">
                  <div th:replace="~{/modules/calendar}"></div>
                  <h1 style="text-align: center; margin-top: 10%;">Note</h1>
                  <button type="button" class="btn btn-default" data-toggle="modal" data-target="#modal-default" style="position: relative; left: 25%; width: 50%; height:60px; margin-bottom: 5%;">
                    Add
                  </button>
                  <div class="input-group-prepend">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                      정렬
                    </button>
                    <div class="dropdown-menu">
                      <button class="dropdown-item sortKeyword-btn" value="1">최신순</button>
                      <div class="dropdown-divider"></div>
                      <button class="dropdown-item sortKeyword-btn" value="2">오래된순</button>
                      <div class="dropdown-divider"></div>
                      <button class="dropdown-item sortKeyword-btn" value="3">종료일자순</button>
                    </div>
                  </div>

                  <div class="list-container">
                    <div class="col-md-13" style="margin: 0 5% 15% 5%;" th:if="${ #lists.isEmpty(scheduleList) }">
                      <div class="card card-primary">
                        <div class="card-header">
                          <h3 class="card-title"></h3>
                          <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="remove">
                              <i class="fas fa-times"></i>
                            </button>
                          </div>
                        </div>
                        <div class="card-body">
                          <div style="text-align:center; color: gray; margin: 20% 10%;">Todo Add 버튼을 눌러 일정을 추가해 주세요</div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <table class="todo-list" id="todo-list-container" style="width:480px;">

                  </table>
                </div>
              </div>
              <div class="tab-pane text-left my-fileBox-div" id="tab3" role="tabpanel" aria-labelledby="my-fileBox-tab">
                <!-- 파일함 검색창 -->
                <div class="card-header att-container">
                  <h3 class="card-title"><span th:text="${ #ctx.session.loginUser.empId }" style="font-weight:bold;"></span><span th:text="|(${ #ctx.session.loginUser.empName })님|"></span></h3>
                  <div class="search-container" style="display: flex; flex-direction: row; row-gap: 2rem;">
                    <div class="card-tools search-tool">
                      <div class="input-group input-group-sm" style="width: 150px;">
<!--                        <input type="text" name="file-search-input" class="form-control float-right file-search-input" placeholder="이름으로 검색">-->
                        <select class="form-control float-right file-search-keyword" th:value="${ fileKeyword }" style="height: 2.3rem;">
                          <option selected value="all">구분(전체)</option>
<!--                          <option th:each="file : ${userFileList}" th:text="${file.fileSort}"></option>-->
                          <option value="개인">개인</option>
                          <option value="업무">업무</option>
                          <option value="제출">제출</option>
                        </select>
                        <div class="input-group-append">
                          <button type="submit" class="btn btn-default" id="file-search-submit-btn">
                            <i class="fas fa-search"></i>
                          </button>
                        </div>
                      </div>
<!--                      <button type="button" class="btn btn-primary file-create-btn" data-toggle="modal" data-target="#modal-file" style="margin-left: 10px;">추가</button>-->
                      <span class="btn btn-primary col fileinput-button file-create-btn" data-toggle="modal" data-target="#modal-file" style="margin-left: 10px;">
                          <i class="fas fa-plus"></i>
                          <span>추가</span>
                      </span>
                    </div>
                  </div>
                </div>
                <!-- /파일함 검색창 -->
                <div class="my-fileBox-container" id="my-fileBox-container">
                파일함 영역
                  <!-- Project list AND Pagination Btn -->

                </div>
              </div>
              <div class="tab-pane fade my-attendance-div" id="tab4" role="tabpanel" aria-labelledby="vert-tabs-messages-tab">
                <!-- 근태현황 검색창 -->
                <div class="card-header att-container">
                  <h3 class="card-title">
                    <span th:text="${ #ctx.session.loginUser.empId }" style="font-weight:bold;"></span>
                    <span th:text="|(${ #ctx.session.loginUser.empName })님|"></span>
                    <span th:text="|[ 사용가능 연차: ${ annualCount } 회 ]|" style="position:relative; left:2%; color:gray;"></span>
                  </h3>
                  <div class="search-container" style="display: flex; flex-direction: row; row-gap: 2rem;">
                    <div class="calendar-container">
                      <div class="date-input">
                        <!-- 달력 icon -->
                        <i class="far fa-calendar-alt"></i>
                        <input type="text" class="form-control datepicker" id="attd-start-date">
                      </div>

                      <div class="date-input">
                        <i class="far fa-calendar-alt"></i>
                        <input type="text" class="form-control datepicker" id="attd-end-date">
                      </div>
                    </div>

                    <div class="date-input month-container">
                      <button type="button" class="btn btn-default attd-month-btn" id="attd-1month-btn" value="1">1개월</button>
                      <button type="button" class="btn btn-default attd-month-btn" id="attd-3month-btn" value="3">3개월</button>
                      <button type="button" class="btn btn-default attd-month-btn" id="attd-6month-btn" value="6">6개월</button>
                    </div>

                    <div class="card-tools search-tool">
                      <div class="input-group input-group-sm" style="width: 150px;">
                        <!--                    <input type="text" name="table_search" class="form-control float-right" placeholder="이름으로 검색">-->
                        <select class="form-control float-right attd-search-keyword" name="attd-search-keyword" th:value="${ attdKeyword }" style="height: 2.3rem;">
                          <option selected value="all">상태(전체)</option>
                          <option th:each="status : ${ attdStatus }" th:text="${ status }"></option>
                        </select>
                        <div class="input-group-append">
                          <button type="submit" class="btn btn-default" id="attd-submit-btn">
                            <i class="fas fa-search"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- /근태현황 검색창 -->
                <div class="attendance-list-container" id="attendance-list-container">
                근태영역
                  <!-- Project list AND Pagination Btn -->
                </div>
              </div>
              <div class="tab-pane fade my-loginAttempt-div" id="tab5" role="tabpanel" aria-labelledby="vert-tabs-settings-tab">
                <!-- 로그인 조회 검색창 -->
                    <div class="card-body table-responsive p-0">
                      <div class="card-header att-container">
                        <h3 class="card-title"><span th:text="${ #ctx.session.loginUser.empId }" style="font-weight:bold;"></span><span th:text="|(${ #ctx.session.loginUser.empName })님|"></span></h3>
                        <div class="search-container" style="display: flex; flex-direction: row; row-gap: 2rem;">
                          <div class="calendar-container">
                            <div class="date-input">
                              <!-- 달력 icon -->
                              <i class="far fa-calendar-alt"></i>
                              <input type="text" class="form-control datepicker" id="login-start-date" th:value="${ startDate }">
                            </div>

                            <div class="date-input">
                              <i class="far fa-calendar-alt"></i>
                              <input type="text" class="form-control datepicker" id="login-end-date" th:value="${ endDate }">
                            </div>
                          </div>

                          <div class="date-input month-container">
                            <button type="button" class="btn btn-default login-month-btn" id="login-1month-btn" value="1">1개월</button>
                            <button type="button" class="btn btn-default login-month-btn" id="login-3month-btn" value="3">3개월</button>
                            <button type="button" class="btn btn-default login-month-btn" id="login-6month-btn" value="6">6개월</button>
                          </div>

                          <div class="card-tools search-tool">
                            <div class="input-group input-group-sm" style="width: 150px;">
                              <!--                    <input type="text" name="table_search" class="form-control float-right" placeholder="이름으로 검색">-->
                              <select class="form-control float-right login-search-keyword" th:value="${ loginKeyword }" style="height: 2.3rem;">
                                <option selected value="all">구분(전체)</option>
                                <option value="login">로그인</option>
                                <option value="logout">로그아웃</option>
                              </select>
                              <div class="input-group-append">
                                <button type="submit" class="btn btn-default" id="login-submit-btn">
                                  <i class="fas fa-search"></i>
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- /로그인 조회 검색창 -->
                      <div class="login-list-container" id="login-list-container">
                      로그인영역
                      <!-- Project list AND Pagination Btn -->
                      </div>
                    </div>
              </div>
              <div class="tab-pane fade my-bookmark-div" id="tab6" role="tabpanel" aria-labelledby="my-bookmark-tab">
                <!-- 북마크 조회 검색창 -->
                <div class="card-body table-responsive p-0">
                  <div class="card-header att-container">
                    <h3 class="card-title"><span th:text="${ #ctx.session.loginUser.empId }" style="font-weight:bold;"></span><span th:text="|(${ #ctx.session.loginUser.empName })님|"></span></h3>
                    <div class="search-container" style="display: flex; flex-direction: row; row-gap: 2rem;">
                      <form>
                      <div class="date-input month-container">
                        <button type="button" class="btn btn-default" id="bookmark-remove-btn">삭제</button>
                        <button type="button" class="btn btn-default" id="send-mail-btn">메일발송</button>
                        <div class="card-tools search-tool">
                          <div class="input-group input-group-sm" style="width: 150px;">
                            <div class="form-group" style="margin:0;">
                              <div class="input-group input-group-lg" style="width:30rem;">
                                <select class="form-control float-right bookmark-search-option" style="font-size:1.0rem;">
                                  <option selected value="all">전체</option>
                                  <option value="name">이름</option>
                                  <option value="email">이메일</option>
                                  <option value="phone">전화번호</option>
                                </select>
                                <input type="text" class="form-control form-control-lg" placeholder="검색" style="font-size:1.0rem;" id="bookmark-search-keyword">
                                <div class="input-group-append">
                                  <button type="submit" class="btn btn-lg btn-default" id="bookmark-submit-btn">
                                    <i class="fa fa-search"></i>
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      </form>
                    </div>
                  </div>
                  <!-- /로그인 조회 검색창 -->
                  <div class="bookmark-list-container" id="bookmark-list-container">
                    즐겨찾기영역
                    <!-- Project list AND Pagination Btn -->
                  </div>
                </div>
              </div>

            </div>
          </div>

    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->


  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>

  </div>
</div>
<div th:replace="~{/modules/main-footer}"></div>


<!-- Bootstrap 4 -->
<script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE App -->
<script src="/dist/js/adminlte.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="/dist/js/demo.js"></script>
<!-- Summernote -->
<script src="/plugins/summernote/summernote-bs4.min.js"></script>
<!-- fullCalendar 2.2.5 -->
<script src="/plugins/moment/moment.min.js"></script>
<script src="/plugins/fullcalendar/main.js"></script>
<!-- Page Script -->
<!-- 지도 -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<!-- date picker -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script src="../../plugins/jquery/jquery.notification.js"></script>
<script th:inline="javascript">
 <!-- 우편번호 찾기 api -->

  // Home에서 개인일정 보러가기
  const tab = /*[[${ #ctx.param.tab }]]*/'';
  if(tab == 1) {
      $('.tab-pane').eq(tab).addClass('show').addClass('active');
      $('.tab-pane').eq(0).removeClass('show').removeClass('active');

      $('.my-info-btn').removeClass('active');
      $('.my-memo-btn').addClass('active');

      $('.my-memo-btn').attr('aria-selected', 'true');
      refreshCalendar();
  }

      // - 전화번호 - 형식 포맷
      function phoneNumberFormat(phoneNumber) {
          function formatPhoneNumber(phoneNumber) {
                // 숫자만 추출
                let cleaned = ('' + phoneNumber).replace(/\D/g, '');

                // 전화번호 포맷
                if (cleaned.length === 11) {
                  return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
                }
                return phoneNumber; // 포맷이 잘못된 경우 원본 반환
          }

          // 모든 연락처 항목을 순회하며 포맷 적용
          $('.phone-replace').each(function() {
            let $this = $(this);
            let phoneNumber = $this.text().trim();
            let formattedNumber = formatPhoneNumber(phoneNumber);
            $this.text(formattedNumber);
          });
      }


function execDaumPostcode() {
       new daum.Postcode({
           oncomplete: function(data) {
               // 팝업을 통한 검색 결과 항목 클릭 시 실행
               var addr = ''; // 주소_결과값이 없을 경우 공백
               var extraAddr = ''; // 참고항목

               //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
               if (data.userSelectedType === 'R') { // 도로명 주소를 선택
                   addr = data.roadAddress;
               } else { // 지번 주소를 선택
                   addr = data.jibunAddress;
               }

               if(data.userSelectedType === 'R'){
                   if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                       extraAddr += data.bname;
                   }
                   if(data.buildingName !== '' && data.apartment === 'Y'){
                       extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                   }
                   if(extraAddr !== ''){
                       extraAddr = ' (' + extraAddr + ')';
                   }
               } else {
                 $('UserAdd1').val('');
               }
             // 선택된 우편번호와 주소 정보를 input 박스에 넣는다.
               $('#zipp_code_id').val(data.zonecode);
               $('#UserAdd1').val(addr);
               $("#UserAdd1").val(function(index, value) {
                       return value + extraAddr;
               });
               $('#UserAdd2').focus(); // 우편번호 + 주소 입력이 완료되었음으로 상세주소로 포커스 이동
           }
       }).open();
 }

 $(function () {
    // ajax.fn
    function commonAjax(url, method, data, dataType="text"){
        return new Promise((resolve, reject) => {
            $.ajax({
                url : url,
                method : method,
                data : data,
                dataType : dataType,
                success : function(result){
                    resolve(result);
                },
                error : function(xhr, status, err) {
                    reject(err);
                }
            });
        });
    };

    function paginationCode(url) {
          // 현재는 페이지가 같아서 선택자로 'load 컨테이너' 안에있는 '.paging'
          let pageNo = $(url).data('pageno');
          const lastPageNo = Math.floor(($(url).data('datacount') / 5) + (($(url).data('datacount') % 5) > 0 ? 1 : 0));
          if (/«/.test($(this).text())) pageNo = 1;
          if ($(this).text() == 'Previous') pageNo = pageNo - 1 < 1 ? 1 : pageNo - 1;
          if ($(this).text() == 'Next') pageNo = pageNo + 1 > lastPageNo ? lastPageNo : pageNo + 1;
          if (/»/.test($(this).text())) pageNo = lastPageNo;
          if (!isNaN($(this).text())) pageNo = $(this).text();
          return pageNo;
    }

    // 마이 페이지 첫 화면
    $('.my-info-div').load('my-information', function(){
          // 휴대폰 번호 형식 안내
          const phoneInput = $('.my-info-div #empPhone');
          phoneInput.on('keydown', function(e) {
                if (e.key === '-') {
                    alert("'-'를 제외한 숫자만 입력해 주세요");
                    e.preventDefault();
                }
          });
    });

    // 데이피커 로드 및 오늘 날짜로 초기값 설정
    function datePickerLoad() {
        $('.datepicker').datepicker({
                format: "yyyy-mm-dd",
                autoclose: true,
                todayHighlight: true,
                lang: 'kr'
        }).datepicker('setDate', new Date()); // 오늘 날짜로 초기값 설정
    }

    $('.my-attendance-btn').on('click', (e) => {
          $('.attendance-list-container').load('my-attendance', function() {
              datePickerLoad();
              $('.attd-search-keyword').val('all');
          });
    });

     $('.my-loginAttempt-btn').on('click', (e) => {
          $('.login-list-container').load('login-attempt', function(){
              datePickerLoad();
              $('.login-search-keyword').val('all');
          });
    });

    $('.my-memo-btn').on('click', (e) => {
          $('.todo-list').load('todo-list');
    });

    $('.my-bookmark-btn').on('click', (e) => {
          $('.bookmark-list-container').load('my-bookmark', function(){
                datePickerLoad();
                phoneNumberFormat();

                $('.bookmark-search-option').val('all');
                $('#bookmark-search-keyword').val('');
          });
    });

    // 즐겨찾기탭 전체선택 or 전체해제 이벤트
    $('.bookmark-list-container').on('change', '#bookmark-all-checkbox', function(e) {
          let chk = $('.bookmark-list-container .book-check');

          if($(this).is(':checked')) {
              chk.prop('checked', true);
          } else {
              chk.prop('checked', false);
          }
    });


    let sortName = '';
    let name = false;
    let dept = false;

    // 즐겨찾기탭 별 표시
    $('.bookmark-list-container').on('click', '.star-check', function(e) {

          let $this = $(this);
          let starCheck = $this.data('star-check');
          let index = $this.data('index');
          let contactId = $('.contact-id').eq(index).text();

          let pageNo = $('.bookmark-list-container .paging').data('pageno');
          let option = $('.bookmark-search-option > option:selected').val();
          let bookmarkKeyword = $('#bookmark-search-keyword').val();

          let value = sortName == 'name' ? name : dept;
          commonAjax('my-bookmark-set', 'POST', { bookmarkActive : starCheck, contactId : contactId })
              .then(result => {
                  $('.bookmark-list-container').load('my-bookmark?pageNo=' + 1 +
                      '&option=' + option +
                      '&keyword=' + bookmarkKeyword +
                      '&sortName=' + sortName +
                      '&sortValue=' + value, function(){
                              phoneNumberFormat();
                      }
                  );
              })
              .catch(err => {
                  alert('실패');
              });

          if(starCheck == true || starCheck == 'true') {
              $(this).attr('data-star-check', 'false');
              $(this).children().removeClass('fas').addClass('far');

          } else {
              $(this).attr('data-star-check', 'true');
              $(this).children().removeClass('far').addClass('fas');
          }
    });

    // 이름 or 부서 정렬 이벤트
    $('.bookmark-list-container').on('click', '.bookmark-sort', function(e) {
          let option = $('.bookmark-search-option > option:selected').val();
          let bookmarkKeyword = $('#bookmark-search-keyword').val();

          sortName = $(this).data('bookmark-sort'); // name or dept
          name = $(this).data('bookmark-name'); // true or false
          dept = $(this).data('bookmark-dept'); // true or false

          if(sortName == 'name')  {
                name = name === true ? false : true
                $(this).data('bookmark-name', name);

                $('.bookmark-list-container').load('my-bookmark?pageNo=' + 1 +
                                              '&option=' + option +
                                              '&keyword=' + bookmarkKeyword +
                                              '&sortName=' + sortName +
                                              '&sortValue=' + name, function(){
                                                      phoneNumberFormat();
                                              }
                );
          }

          if(sortName == 'dept') {
                dept = dept === true ? false : true
                $(this).data('bookmark-dept', dept);

                // ajax code
                $('.bookmark-list-container').load('my-bookmark?pageNo=' + 1 +
                                              '&option=' + option +
                                              '&keyword=' + bookmarkKeyword +
                                              '&sortName=' + sortName +
                                              '&sortValue=' + dept, function(){
                                                      phoneNumberFormat();
                                              }
                );
          }
    });

    // 즐겨찾기 탭에서 삭제
    $('#bookmark-remove-btn').on('click', function(e) {
          e.preventDefault();
          e.stopPropagation();

          let dataToSend = [];
          $('#bookmark-table tbody tr').each(function() {
                let $row = $(this);
                let $checkbox = $row.find('.book-check');

                if($checkbox.is(':checked')) {
                      let contactName = $row.find('td').eq(2).text();
                      let contactId = $row.find('td').eq(3).text();

                      dataToSend.push({
                          empName: contactName,
                          contactId: contactId,
                      });
                }
          });

        if (dataToSend.length > 0) {
            // `empName`을 배열로 수집
            let names = dataToSend.map(item => item.empName);

            let confirmMessage;

            // 1명이면
            if (dataToSend.length === 1) {
                confirmMessage = names[0] + '님을 삭제하시겠습니까?';
            } else {
                // 2명 이상부터
                let namesString = names.join(', ');
                confirmMessage = namesString + '님을 삭제하시겠습니까?';
            }

            if (confirm(confirmMessage)) {
                new Promise((resolve, reject) => {
                      $.ajax({
                          url: "my-bookmark-delete",
                          method: "POST",
                          traditional: true,
                          data: JSON.stringify(dataToSend),
                          contentType: 'application/json; charset=UTF-8',
                          success: function(result, status, xhr) {
                                resolve(result);
                          },
                          error: function(xhr, status, err) {
                                reject(err);
                          }
                      });
                })
                .then(result => {
                    alert('삭제 완료되었습니다');
                    $('.bookmark-list-container').load('my-bookmark', function(){
                            phoneNumberFormat();
                    });
                })
                .catch(err => {
                    alert("삭제 실패");
                });
            }
        } else {
            alert('항목이 선택되지 않았습니다');
        }
    });

    // 체크한 사람 메일발송
    $('#send-mail-btn').on('click', function(e) {
          e.preventDefault();
          e.stopPropagation();

          let dataToSend = [];
          let count = 0;
          $('#bookmark-table tbody tr').each(function() {
                let $row = $(this);
                let $checkbox = $row.find('.book-check');
                if($checkbox.is(':checked')) {
                      count++;
                      let empName = $row.find('td').eq(2).text();
                      let email = $row.find('td').eq(5).text();
                      dataToSend.push({
                          emails: email,
                          empName : empName,
                      });
                }
          });

          if(count > 0) {
                // `empName`을 배열로 수집
                let names = dataToSend.map(item => item.empName);

                let confirmMessage;

                // 1명이면
                if (dataToSend.length === 1) {
                    confirmMessage = names[0] + '님에게 이메일을 전송하시겠습니까?';
                } else {
                    // 2명 이상부터
                    let namesString = names.join(', ');
                    confirmMessage = namesString + '님에게 이메일을 전송하시겠습니까?';
                }

                if(confirm(confirmMessage)){
                    const emailFromArray = dataToSend.map(item => item.emails);
                    const emailFromQuery = emailFromArray.join(',');
                    location.href = '/mailbox/write?emails=' + encodeURIComponent(emailFromQuery);
                }
          } else {
                alert('항목이 선택되지 않았습니다');
          }
    });

    // Pagination 버튼 Ajax - 즐겨찾기
    $('.bookmark-list-container').on('click', '.page-item', function(e) {
        let pageNo = $('.bookmark-list-container .paging').data('pageno');
        const lastPageNo = Math.floor(($('.bookmark-list-container .paging').data('datacount') / 5) + (($('.bookmark-list-container .paging').data('datacount') % 5) > 0 ? 1 : 0));
        if (/«/.test($(this).text())) pageNo = 1;
        if ($(this).text() == 'Previous') pageNo = pageNo - 1 < 1 ? 1 : pageNo - 1;
        if ($(this).text() == 'Next') pageNo = pageNo + 1 > lastPageNo ? lastPageNo : pageNo + 1;
        if (/»/.test($(this).text())) pageNo = lastPageNo;
        if (!isNaN($(this).text())) pageNo = $(this).text();

        let option = $('.bookmark-search-option > option:selected').val();
        let bookmarkKeyword = $('#bookmark-search-keyword').val();
        let value = sortName == 'name' ? name : dept;

        $('.bookmark-list-container').load('my-bookmark?pageNo=' + pageNo +
                                             '&option=' + option +
                                              '&keyword=' + bookmarkKeyword +
                                              '&sortName=' + sortName +
                                              '&sortValue=' + value, function(){
                                                        phoneNumberFormat();
                                               });
    });

    // 즐겨찾기 서치
    $('#bookmark-submit-btn').on('click', function(e) {
          e.preventDefault();
          e.stopPropagation();

          let option = $('.bookmark-search-option > option:selected').val();
          let bookmarkKeyword = $('#bookmark-search-keyword').val();

          if(option != 'all' && bookmarkKeyword == '') {
              alert('검색어를 입력해 주세요');
              return;
          }

          $('.bookmark-list-container').load('my-bookmark?pageNo=' + 1 +
                                '&option=' + option +
                                '&keyword=' + bookmarkKeyword, function(){
                                      phoneNumberFormat();
          });
    });

    // 파일함 로드
    $('.my-fileBox-btn').on('click', (e) => {
          $('.my-fileBox-container').load('my-file-box', function(){
              truncateUserFileName();
              $('.file-search-keyword').val('all');
          });
    });

    // userFileName 25자 이상 ...으로 대체
    function truncateUserFileName() {
        let maxLength = 25; // 표시할 최대 글자 수
        $('.my-fileBox-container .userFileName').each(function() {
              let text = $(this).text();
              if (text.length > maxLength) {
                  let truncatedText = text.substr(0, maxLength - 2) + '...';
                  $(this).text(truncatedText);
              }
        });
    }

    // 파일 등록페이지 로드
    $('#file-create-btn').on('click', (e) => {
          $('.my-fileBox-container').load('my-file-create');
    });

    // 파일 등록 저장 버튼
    $('.my-fileBox-container').on('click', '#file-submit-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();

            if($('#note').val() == '') {
                alert('메모를 입력해 주세요');
                return;
            }
            let getFile = $('.my-fileBox-container #attach')[0];
            let file = getFile.files[0];
            if(!file) {
                alert('첨부 파일을 등록해 주세요');
                return;
            }

            let formData = new FormData();
            let fileInput = $('input[name="attach"]')[0];

            if (fileInput.files.length > 0) {
                formData.append('attach', fileInput.files[0]);
            }

            formData.append('empId', $('#empId').val());
            formData.append('note', $('#note').val());
            formData.append('fileSort', $('#file-create-Sort').val());

            if(confirm('파일을 등록하시겠습니까?')){
                  $('#modal-file').modal('hide');
                  new Promise((resolve, reject) => {
                      $.ajax({
                          "url" : "my-file-save",
                          "method" : "POST",
                          "data" : formData,
                          "processData": false,
                          "contentType": false,
                          "success": function(result) {
                              resolve(result);
                          },
                          "error": function(xhr, status, err) {
                              reject(err);
                          }
                      });
                  })
                  .then(result => {
                      if(result === 'success'){
                          alert('파일 등록이 완료되었습니다');
                          $('.my-fileBox-container').load('my-file-box', function(){
                              truncateUserFileName();
                          });
                      } else {
                          alert('파일 등록에 실패하였습니다')
                      }
                  })
                  .catch(err => {
                      alert("파일 등록 에러");
                  });
            }
    });

        // Pagination 버튼 Ajax - 파일함
        $('.my-fileBox-container').on('click', '.page-item', function(e) {
            let pageNo = $('.my-fileBox-container .paging').data('pageno');
            const lastPageNo = Math.floor(($('.my-fileBox-container .paging').data('datacount') / 5) + (($('.my-fileBox-container .paging').data('datacount') % 5) > 0 ? 1 : 0));
            if (/«/.test($(this).text())) pageNo = 1;
            if ($(this).text() == 'Previous') pageNo = pageNo - 1 < 1 ? 1 : pageNo - 1;
            if ($(this).text() == 'Next') pageNo = pageNo + 1 > lastPageNo ? lastPageNo : pageNo + 1;
            if (/»/.test($(this).text())) pageNo = lastPageNo;
            if (!isNaN($(this).text())) pageNo = $(this).text();

            let fileKeyword = $('.file-search-keyword > option:selected').val();

            $('.my-fileBox-container').load('my-file-box?pageNo=' + pageNo + '&keyword=' + fileKeyword, function(){
                   truncateUserFileName();
            });
        });

        // 파일함 구분 버튼
        $('#file-search-submit-btn').on('click', function(e) {
              e.preventDefault();
              e.stopPropagation();

              let fileKeyword = $('.file-search-keyword > option:selected').val();

             $('.my-fileBox-container').load('my-file-box?pageNo=' + 1 + '&keyword=' + fileKeyword, function(){
                    truncateUserFileName();
             });
        });

        $('.my-fileBox-container').on('click', '#file-remove-btn', function(e) {
               if(confirm('해당 파일을 삭제하겠습니까?')) {
                    const fileNo = $(this).data('fileno');

                    commonAjax('userFile-remove', 'GET', { fileNo : fileNo })
                        .then(result => {
                            if(result === 'success') {
                                alert('삭제 완료되었습니다');
                                $('.my-fileBox-container').load('my-file-box', function(){
                                    truncateUserFileName();
                                });
                            } else {
                                alert('파일 삭제에 실패하였습니다');
                            }
                        })
                        .catch(err => {
                            alert('파일 삭제 중 오류가 발생했습니다');
                        })
               }
        });


    // Pagination 버튼 Ajax - 근태현황
        $('.attendance-list-container').on('click', '.page-item', function(e) {
            let pageNo = $('.attendance-list-container .paging').data('pageno');
            const lastPageNo = Math.floor(($('.attendance-list-container .paging').data('datacount') / 5) + (($('.attendance-list-container .paging').data('datacount') % 5) > 0 ? 1 : 0));
            if (/«/.test($(this).text())) pageNo = 1;
            if ($(this).text() == 'Previous') pageNo = pageNo - 1 < 1 ? 1 : pageNo - 1;
            if ($(this).text() == 'Next') pageNo = pageNo + 1 > lastPageNo ? lastPageNo : pageNo + 1;
            if (/»/.test($(this).text())) pageNo = lastPageNo;
            if (!isNaN($(this).text())) pageNo = $(this).text();

            let attdKeyword = $('.attd-search-keyword > option:selected').val();
            let startDate = $('#attd-start-date').val();
            let endDate = $('#attd-end-date').val();
            $('.attendance-list-container').load('my-attendance?pageNo=' + pageNo +
                                                 '&keyword=' + attdKeyword +
                                                 '&startDate=' + startDate +
                                                 '&endDate=' + endDate);
        });

        // 근태현황 n개월 선택 버튼
        $('.attd-month-btn').on('click', function(e){
              switch($(this).val()) {
                  case '1' :
                      $('#attd-start-date').datepicker('setDate', '-1M');
                      break;
                  case '3' :
                      $('#attd-start-date').datepicker('setDate', '-3M');
                      break;
                  case '6' :
                      $('#attd-start-date').datepicker('setDate', '-6M');
                      break;
              }
        });

        // 근태현황 조회 서치 버튼
        $('#attd-submit-btn').on('click', function(e) {
               e.preventDefault();
               e.stopPropagation();

               let attdKeyword = $('.attd-search-keyword > option:selected').val();
               let startDate = $('#attd-start-date').val();
               let endDate = $('#attd-end-date').val();
               //const dateCheck = (/^\d{4}-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])$/);

              if( startDate == '') {
                  alert('시작 날짜를 선택해 주세요');
                  $('#attd-start-date').focus();
                  return;
              } else if( endDate == '') {
                  alert('종료 날짜를 선택해 주세요');
                  $('#attd-end-date').focus();
                  return;
              }

              $('.attendance-list-container').load('my-attendance?pageNo=' + 1 +
                                                                '&keyword=' + attdKeyword +
                                                                '&startDate=' + startDate +
                                                                '&endDate=' + endDate);
        });

        // 근태 수정요청
        $('.attendance-list-container').on('click', '.request-modify-button', function(e) {
            var row = $(this).closest('tr');
            var empId = row.find('td').eq(0).text();
            var attdDate = $('#attd-attdDate').val();

//            $('#attd-attdDate').val();

            $('#empId2').val(empId);
            $('#attdDate2').val(attdDate);

            // 모달을 엽니다.
            //$('#modal-attendance-edit').modal('show');
        });
            ////////////////////// 형준 //////////////////////

        $('.attendance-list-container').on('click', '#modifyRequest', function() {
        var empId = $('#empId2').val();
        var attdDate = $('#attdDate2').val().trim();
        var attdDetail = $('#attdDetail').val();

        var data = {
            empId: empId,
            attdDateStr: attdDate,
            attdDetail: attdDetail
        };

        console.log("Sending data:", data); // 전송 데이터 로그 확인

        // AJAX 요청
        $.ajax({
            type: 'POST',
            url: '/pages/attendance/attendance-list',
            data: JSON.stringify(data),
            contentType: 'application/json',
            dataType: 'text',
            success: function(response, status, xhr) {
                console.log('AJAX 성공:', response);
                window.alert('수정 요청 완료');
                $('#modal-attendance-edit').modal('hide');
                location.reload();
            },
            error: function(xhr, status, error) {
                console.log('AJAX 오류:', error);
            }
        });
    });

    // Pagination 버튼 Ajax - 로그인 조회
        $('.login-list-container').on('click', '.page-item', function(e) {
            let pageNo = $('.my-loginAttempt-div .paging').data('pageno');
            const lastPageNo = Math.floor(($('.my-loginAttempt-div .paging').data('datacount') / 5) + (($('.my-loginAttempt-div .paging').data('datacount') % 5) > 0 ? 1 : 0));
            if (/«/.test($(this).text())) pageNo = 1;
            if ($(this).text() == 'Previous') pageNo = pageNo - 1 < 1 ? 1 : pageNo - 1;
            if ($(this).text() == 'Next') pageNo = pageNo + 1 > lastPageNo ? lastPageNo : pageNo + 1;
            if (/»/.test($(this).text())) pageNo = lastPageNo;
            if (!isNaN($(this).text())) pageNo = $(this).text();

            let loginKeyword = $('.login-search-keyword > option:selected').val();
            let startDate = $('#login-start-date').val();
            let endDate = $('#login-end-date').val();
            $('.login-list-container').load('login-attempt?pageNo=' + pageNo +
                                                          '&keyword=' + loginKeyword +
                                                          '&startDate=' + startDate +
                                                          '&endDate=' + endDate);

        });

        // 로그인 조회 n개월 선택 버튼
        $('.login-month-btn').on('click', function(e){
              switch($(this).val()) {
                  case '1' :
                      $('#login-start-date').datepicker('setDate', '-1M');
                      break;
                  case '3' :
                      $('#login-start-date').datepicker('setDate', '-3M');
                      break;
                  case '6' :
                      $('#login-start-date').datepicker('setDate', '-6M');
                      break;
              }
        });

        // 로그인 조회 서치 버튼
        $('#login-submit-btn').on('click', function(e) {
              e.preventDefault();
              e.stopPropagation();

              let loginKeyword = $('.login-search-keyword > option:selected').val();
              let startDate = $('#login-start-date').val();
              let endDate = $('#login-end-date').val();

              if( startDate == '') {
                  alert('시작 날짜를 선택해 주세요');
                  startDate.focus();
                  return;
              } else if( endDate == '') {
                  alert('종료 날짜를 선택해 주세요');
                  endDate.focus();
                  return;
              }

              $('.login-list-container').load('login-attempt?pageNo=' + 1 +
                                                      '&keyword=' + loginKeyword +
                                                      '&startDate=' + startDate +
                                                      '&endDate=' + endDate);
        });



        // 내 정보 (첫 페이지)
        $('.my-info-div').on('click', '#cancel-btn', function(e) {
            e.stopPropagation();
            e.preventDefault();
            history.back();
       });

       // 이미지 파일만 첨부하는 유효성 함수
       function chk_file_type(fileInput) {
               let file_kind = fileInput.value.lastIndexOf('.');
               let file_name = fileInput.value.substring(file_kind+1,fileInput.length);
               let file_type = file_name.toLowerCase();

               let check_file_type=new Array();

               check_file_type=['jpg','png','jpeg','bmp', ''];

               if(check_file_type.indexOf(file_type)==-1){
                    alert('프로필 사진은 이미지 파일만 선택할 수 있습니다');
                    let parent_Obj=fileInput.parentNode
                    let node=parent_Obj.replaceChild(fileInput.cloneNode(true),fileInput);
                    return false;
               }
               return true;
      }

       $('.my-info-div').on('click', '#submit-btn', function(e) {
           e.stopPropagation();
           e.preventDefault();

           const empId = $('#empId').val();
           const phone = $('#empPhone').val();
           const address = $('#UserAdd1').val();
           const addressDetail = $('#UserAdd2').val();
           const empEmail = $('#empEmail').val();

           if(phone == '') {
                 alert('휴대폰 번호를 입력해 주세요');
                 $('#empPhone').focus();
                 return;
           } else if(address == '') {
                  alert('우편번호 찾기를 진행해 주세요');
                  return;
           } else if(addressDetail == '') {
                  alert('나머지 주소를 입력해 주세요');
                  $('#UserAdd2').focus();
                  return;
           } else if(empEmail == '') {
                  alert('이메일을 입력해 주세요');
                  $('#empEmail').focus();
                  return;
           }

           if(phone.length < 11) {
                 alert('휴대폰 번호를 다시 확인해 주세요');
                 $('#empPhone').focus();
                 return;
           }
           const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
           if (!emailRegex.test(empEmail)) {
                alert("'@'를 포함하여 이메일을 작성해 주세요");
                $('#empEmail').focus();
                return;
           }


           let formData = new FormData();
           let fileInput = $('.my-info-div input[name="info-attach"]')[0];

           if(fileInput.files.length > 0) {
              formData.append('attach', fileInput.files[0]);
           }

           formData.append('empId', empId);
           formData.append('empPhone', phone);
           formData.append('empAddress', address);
           formData.append('empAddressDetail', addressDetail);
           formData.append('empEmail', empEmail);


           if (!chk_file_type(fileInput)) {
               return; // 파일 유효성 실패시
           }

           if(confirm('수정 사항을 저장하시겠습니까?')) {
                   new Promise((resolve, reject) => {
                          $.ajax({
                              "url" : "my-information-edit",
                              "data" : formData,
                              "method" : "POST",
                              "data" : formData,
                              "processData": false,
                              "contentType": false,
                              "success" : function(result) {
                                  resolve(result);
                              },
                              "error" : function( xhz, status, err) {
                                  reject(err);
                              }
                          });
                      })
                      .then(result => {
                          if(result === 'success') {
                              alert('정보 수정이 완료되었습니다');
                              location.href = 'my-page';
                          } else {
                              alert('정보 수정에 실패하였습니다');
                          }
                      })
                      .catch(err => {
                          alert('에러구역');
                      });
                   $('information-form').submit();
          }
       });


        // 메모장 삭제
        $('.todo-list').on('click', '.todo-remove-btn', function(e) {
            e.stopPropagation();
            e.preventDefault();

            const scheduleNo = $(this).data('schedule-no');
            console.log(scheduleNo);

            if(confirm('해당 메모를 삭제하시겠습니까?')) {
                  commonAjax('todo-delete', 'GET', { scheduleNo : scheduleNo })
                      .then(result => {
                            if(result === 'success') {
                                alert('삭제 완료되었습니다');
                                $('.todo-list').load('todo-list');
                            } else {
                                alert('삭제 도중 오류가 발생했습니다');
                            }
                      })
                      .catch(err => {
                            if(result === 'success') {
                                alert('삭제 완료되었습니다');
                                $('.todo-list').load('todo-list');
                            } else {
                                alert('삭제 도중 오류가 발생했습니다');
                            }
                      });
            }
        });

      // 메모 등록
      // $('.todo-list').on('click', '#submit-btn', function(e) {
      $('#todo-submit-btn').on('click', function(e) {

            const start = $('#personalScheduleStartDate').val();
            const end = $('#personalScheduleEndDate').val();
            const content = $('#personalScheduleContent').val().trim();
            const empId = $('#empId').val();

            if(start == '' || end == '') {
                  alert('시작일/종료일을 선택해 주세요');
                  return;
            } else if(content == '') {
                  alert('내용을 입력해 주세요');
                  return;
            }

            if(confirm('등록하시겠습니까?')) {
                        commonAjax('todo-add', 'GET', { "personalScheduleStartDate" : start,
                                    "personalScheduleEndDate" : end,
                                    "personalScheduleContent" : content,
                                    "empId" : empId })
                        .then(result => {
                            if(result === 'success') {
                                alert('등록이 완료되었습니다.');
                                $('.modal').modal('hide');
                            } else {
                                alert('등록 도중 오류가 발생했습니다');
                            }
                            // setTimeout(() => $('#todo-list-container').load('todo-list'), 300);
                            $('#todo-list-container').load('todo-list');
                        })
                        .catch(err => {
                            alert('에러구역');
                        });
            }
      });

      // 메모장 정렬
      $('.sortKeyword-btn').on('click',function(e) {
            const keyword = $(this).val();
            console.log(keyword);
            $('.todo-list').load('todo-list?sortKeyword=' + keyword);

      });

    // //////////////////////////////////////////////////////////////////////////////////////////////////////////
  // shown.bs.tab? 탭이 표시된 후 즉시 작업을 수행해야 할 때 유용한 이벤트
  $('a.my-memo-btn#vert-tabs-profile-tab').on('shown.bs.tab', function(e){
        refreshCalendar();
  });
});



</script>

  <!-- ./wrapper -->
  <!-- Todo-List 추가 모달  -->
  <div class="modal fade" id="modal-default" tabindex="-1" role="dialog" aria-labelledby="add-todo-list-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="add-todo-list-label">Todo-List-Add</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <!-- 모달창 바디 start -->
        <div class="modal-body">
          <form action="my-page" method="post" id="todo-add-form">
            <div class="col">
              <div class="card card-primary">
                <div class="card-body">
                  <input type="hidden" name="empId" id="empId" th:value="${ #ctx.session.loginUser.empId }">
                  <div class="form-group">
                    <label for="personalScheduleStartDate">시작일</label>
                    <input type="date" name="personalScheduleStartDate" id="personalScheduleStartDate" class="form-control" required>
                  </div>
                  <div class="form-group">
                    <label for="personalScheduleEndDate">종료일</label>
                    <input type="date" name="personalScheduleEndDate" id="personalScheduleEndDate" class="form-control" required>
                  </div>
                  <div class="form-group">
                    <label for="personalScheduleContent">내용</label>
                    <textarea name="personalScheduleContent" id="personalScheduleContent" class="form-control" rows="4" placeholder="내용을 입력하세요" required ></textarea>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div><!-- 모달창 바디 and -->
        <div class="modal-footer"> <!-- justify-content-between << 각각 양쪽끝에 배치-->
          <button type="submit" class="btn btn-primary" id="todo-submit-btn">저장</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
        </div>
      </div>
    </div>
  </div>
  empId = /*[[${session.loginUser.empId}]]*/ 0;initializeWebSocket(empId);
</body>
</html>
